// E-Commerce Database Schema
// Uses PostgreSQL via Supabase


generator client {
  provider = "prisma-client-js"
  output   = "./generated/main"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}
        

// ============================================
// USER MODELS
// ============================================

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  password      String
  name          String
  walletPoints  Decimal        @default(0) @db.Decimal(10, 2)
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  // Relations
  cart          Cart[]
  orders        Order[]
  userCoupons   UserCoupon[]

  @@index([email])
  @@map("users")
}

// ============================================
// SELLER MODELS
// ============================================

model Seller {
  id            String         @id @default(uuid())
  email         String         @unique
  password      String
  name          String
  shopName      String         @map("shop_name")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  // Relations
  products      Product[]

  @@index([email])
  @@map("sellers")
}

// ============================================
// PRODUCT MODELS
// ============================================

model Product {
  id            String         @id @default(uuid())
  sellerId      String         @map("seller_id")
  name          String
  description   String?
  price         Decimal        @db.Decimal(10, 2)
  stock         Int            @default(0)
  isActive      Boolean        @default(true) @map("is_active")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  // Relations
  seller        Seller         @relation(fields: [sellerId], references: [id], onDelete: Restrict)
  cartItems     Cart[]
  orderItems    OrderItem[]

  // Indexes for performance
  @@index([sellerId])
  @@index([isActive])
  @@map("products")
}

// ============================================
// COUPON MODELS
// ============================================

enum DiscountType {
  PERCENTAGE
  FIXED
}

model Coupon {
  id                  String         @id @default(uuid())
  code                String         @unique
  discountType        DiscountType   @map("discount_type")
  discountValue       Decimal        @map("discount_value") @db.Decimal(10, 2)
  minPurchase         Decimal?       @map("min_purchase") @db.Decimal(10, 2)
  maxDiscount         Decimal?       @map("max_discount") @db.Decimal(10, 2)

  // Usage limits (null = unlimited)
  usageLimitPerUser   Int?           @map("usage_limit_per_user")
  totalUsageLimit     Int?           @map("total_usage_limit")
  currentUsageCount   Int            @default(0) @map("current_usage_count")

  validFrom           DateTime       @map("valid_from")
  validTo             DateTime       @map("valid_to")
  isActive            Boolean        @default(true) @map("is_active")
  createdAt           DateTime       @default(now()) @map("created_at")
  updatedAt           DateTime       @updatedAt @map("updated_at")

  // Relations
  userCoupons         UserCoupon[]
  orders              Order[]

  @@index([code])
  @@index([isActive])
  @@map("coupons")
}

model UserCoupon {
  id            String         @id @default(uuid())
  userId        String         @map("user_id")
  couponId      String         @map("coupon_id")
  usageCount    Int            @default(0) @map("usage_count")
  lastUsedAt    DateTime?      @map("last_used_at")
  createdAt     DateTime       @default(now()) @map("created_at")

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  coupon        Coupon         @relation(fields: [couponId], references: [id], onDelete: Restrict)

  @@unique([userId, couponId])
  @@index([userId])
  @@index([couponId])
  @@map("user_coupons")
}

// ============================================
// CART MODELS
// ============================================

model Cart {
  id            String         @id @default(uuid())
  userId        String         @map("user_id")
  productId     String         @map("product_id")
  quantity      Int            @default(1)
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  product       Product        @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@map("cart")
}

// ============================================
// ORDER MODELS
// ============================================

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

model Order {
  id                String         @id @default(uuid())
  userId            String         @map("user_id")
  couponId          String?        @map("coupon_id")
  totalAmount       Decimal        @map("total_amount") @db.Decimal(10, 2)
  couponDiscount    Decimal        @default(0) @map("coupon_discount") @db.Decimal(10, 2)
  walletPointsUsed  Decimal        @default(0) @map("wallet_points_used") @db.Decimal(10, 2)
  finalAmount       Decimal        @map("final_amount") @db.Decimal(10, 2)
  paymentStatus     PaymentStatus  @default(PENDING) @map("payment_status")
  orderStatus       OrderStatus    @default(PENDING) @map("order_status")
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")

  // Relations
  user              User           @relation(fields: [userId], references: [id], onDelete: Restrict)
  coupon            Coupon?        @relation(fields: [couponId], references: [id], onDelete: SetNull)
  orderItems        OrderItem[]
  transaction       Transaction?

  @@index([userId])
  @@index([paymentStatus])
  @@index([orderStatus])
  @@map("orders")
}

model OrderItem {
  id            String         @id @default(uuid())
  orderId       String         @map("order_id")
  productId     String         @map("product_id")
  quantity      Int
  price         Decimal        @db.Decimal(10, 2)
  createdAt     DateTime       @default(now()) @map("created_at")

  // Relations
  order         Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product       Product        @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// ============================================
// PAYMENT/TRANSACTION MODELS
// ============================================

model Transaction {
  id              String         @id @default(uuid())
  orderId         String         @unique @map("order_id")
  paymentStatus   PaymentStatus  @default(PENDING) @map("payment_status")
  paymentMethod   String?        @map("payment_method")
  transactionId   String?        @unique @map("transaction_id")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  // Relations
  order           Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([transactionId])
  @@map("transactions")
}
